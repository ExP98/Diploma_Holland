---
title: "Чтение данных"
author: "Egor Glushkov"
---

# 1. Библиотеки

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(xlsx)
# library(jsonlite)
library(psych) # desc stats
library(here)

here::here()
```

```{r}
extract_psytest_result <- function(res_str) {
  res <- res_str %>%
    str_extract("\\{[^\\}]*\\}") %>%
    str_replace_all("\\{|\\}", "") %>%
    str_split_1(",") %>%
    str_split(":") %>%
    sapply(\(elem) setNames(as.list(elem[[2]]), elem[[1]])) %>%
    as.data.frame()
  return(res)
}
```


# 2. Данные

```{r}
data <- fread(paste0(here(), "/0. Data/AllTestsData_092024.csv"))
all_tests <- data[["test_short_name"]] %>% unique()

wide_data <- data %>%
  copy() %>% 
  .[, result := lapply(result, extract_psytest_result)] %>% 
  pivot_wider(names_from = "test_short_name", values_from = result) %>% 
  unnest(cols = -id, names_sep = " / ") %>% 
  as.data.table() %>% 
  .[, names(.) := lapply(.SD, as.integer)] %>% 
  # 2 пропуска в кодах Голланда, которые на самом деле нули
  mutate(across(matches("golland "), \(x) replace(x, is.na(x), 0))) %>% 
  # у первых двух субъектов сумма кодов Голланда не 42. Исправим это:
  mutate(`golland / X1` = if_else(id == "10749", 14, `golland / X1`)) %>% 
  mutate(`golland / X6` = if_else(id == "39803",  1, `golland / X6`))
```

Big Five - 5 факторов
temperament - 4
cattell - 16
golland - 6
leonhard - 10
schwartz - 20
golland_v2 - 6
--
id + 67 факторов


## Переименование переменных

```{r}
new_short_names <- wide_data %>%
  copy() %>% 
  colnames() %>% 
  data.table(full_name = .) %>% 
  .[, test_name := sapply(full_name, \(x) str_split_1(x, " / ")[1])] %>% 
  .[, short_test := case_match(test_name, 
                               "big_five" ~ "BF",
                               "temperament" ~ "EY",
                               "cattell_poll" ~ "CT",
                               "golland" ~ "HL",
                               "leonhard_poll" ~ "LN",
                               "schwartz_poll" ~ "SC",
                               "golland_v2" ~ "HL2")] %>% 
  .[, .(full_name, test_name, short_test, cur = 1:.N), by = short_test] %>% 
  .[, .(full_name, short_name = if_else(!is.na(short_test), str_c(short_test, "_", cur), full_name))]

wide_data <- wide_data %>% rename_all(~new_short_names[["short_name"]])
```


# 3. Проверка данных

## Количество тестов у людей и количество людей по тестам
```{r}
data[, .N, by = c("id")][, .N, by = "N"]
data[, .N, by = c("test_short_name")]
```
У 16 человек пройдено 7 тестов, у 323 -- 6 тестов. Тот доп. тест у 16 человек -- golland_v2

## Различные тесты Голланда у одних людей
```{r}
data %>%
  pivot_wider(names_from = "test_short_name", values_from = result) %>%
  filter(!is.na(golland_v2)) %>%
  select(id, golland, golland_v2) %>%
  view()
```


## Корреляции

```{r}
png(filename = "../../0. Data/Output/cor.png")

cor_plot <- wide_data %>% 
  select(matches("golland ")) %>% 
  cor.plot(main = "Матрица корреляций факторов\nмодели Голланда (N = 339)", 
           labels = c("R", "I", "A", "S", "E", "C"),
           cex = 1, scale = FALSE, diag = FALSE, upper = TRUE)

recordPlot()
dev.off()
```


```{r}
cor_mat <- wide_data %>% cor() 
cor_mat[upper.tri(cor_mat)] <- NA

cor_df <- cor_mat %>% 
  as.data.frame() %>% 
  rownames_to_column("factor1") %>% 
  pivot_longer(cols = -factor1, names_to = "factor2") %>% 
  filter(factor1 != factor2, factor1 != "id", factor2 != "id", !is.na(value)) %>% 
  as.data.table()

# ggplot(cor_df[value > 0.5], aes(x = value)) +
#   geom_histogram(color = "black", fill = "steelblue", bins = 30) +
#   labs(x = "Коэффициент корреляции", y = "Частота") + 
#   ggtitle("Гистограмма частот для коэффицента корреляции > 0.5") +
#   theme_minimal()
```
Среди скоррелированных признаков нет кодов Голланда -- хорошо.

```{r}
# cor_df %>% 
  # filter(value > 0.6) %>% 
  # view()

cor_df %>% 
  separate_wider_delim(cols = 1:2, delim = " / ", names = c("test", "feature"), names_sep = "_") %>% 
  mutate(across(matches("feature"), feature_replacement)) %>% 
  mutate(factor1_feature = if_else(factor1_test == "golland", factor1_feature %>% golland_enum(), factor1_feature)) %>% 
  mutate(factor2_feature = if_else(factor2_test == "golland", factor2_feature %>% golland_enum(), factor2_feature)) %>% 

  replace_col_using_df("factor1_test", test_names_df) %>% 
  replace_col_using_df("factor1_feature", leonhard_rus_factors) %>% 
  replace_col_using_df("factor1_feature", cattell_rus_factors) %>%  
  replace_col_using_df("factor2_test", test_names_df) %>% 
  replace_col_using_df("factor2_feature", leonhard_rus_factors) %>% 
  replace_col_using_df("factor2_feature", cattell_rus_factors) %>% 
  
  filter(value > 0.65) %>% 
  arrange(-value) %>% 
  mutate(value = value %>% round(digits = 2) %>% as.character() %>% str_replace("\\.", ",")) %>% 
  write.xlsx2("../../0. Data/Output/max_cor.xlsx")
```


## Пропуски

```{r}
wide_data %>% 
  select(-matches("golland_v2|HL2")) %>%
  is.na() %>%
  sum()
```
2 пропуска

```{r}
wide_data %>% is.na() %>% colSums() %>% .[. != 0]
```
Есть по пропуску в golland X1 и X6 (в разных строках) -- заполнить нулями, ибо в тех строках сумма уже 42, значит, там пусто.


## Сумма признаков кода Голланда

Сумма фичей кодов Голланда const? Да, 42
```{r}
wide_data %>%
  select(id, matches("golland ")) %>%
  mutate(rs = rowSums(across(paste0("golland / X", 1:6)), na.rm = TRUE)) %>% 
  # filter(is.na(`golland / X1`) | is.na(`golland / X6`))
  filter(rs != 42)
```
Почти у всех 42, кроме двоих (первых двух!).
- Пользователь 10749: у него 41 в сумме, но у него есть golland_v2, где все значения идентичны, только X1 на 1 больше (и будет 42). Меняем `golland / X1` на 14 у 10749.
- У 39803 на 13 больше нужного. Притом его результаты почти совпадают с результатами второго, у которого 6ой признак на 13 же больше. Меняем его `golland / X6` с 14 на 1.


Проверить такую же сумму по другим тестам. В итоге лишь в golland_v2 сумма постоянна (и там всё ок):
```{r}
wide_data %>%
  select(matches("golland_v2 ")) %>%
  mutate(rs = rowSums(across(everything()), na.rm = TRUE)) %>% 
  filter(rs != 0)
```


# 4. Описательная статистика
```{r}
show_desc_stats <- function(data) {
  return(psych::describe(data, skew = FALSE, quant = c(.25, .75)) %>% 
           select(vars, n, min, Q0.25, mean, median, Q0.75, max, range, sd, se))
}


feature_replacement <- function(str) {
  str %>% str_replace("(\\.)+", " - ") %>% str_replace_all("_", " ") %>% str_replace_all("\\.", " ") %>% str_trim()
}


golland_enum <- function(str) {
  riasec <- c(
    "Реалистический (R)", 
    "Исследовательский (I)",
    "Артистический (A)",
    "Социальный (S)",
    "Предприимчивый (E)",
    "Традиционный (C)"
  )
  # riasec <- c("R", "I", "A", "S", "E", "C")
  return(str %>% str_replace("X", "") %>% as.numeric() %>% riasec[.])
}


replace_col_using_df <- function(data, var_name, dict_df) {
  data <- data %>% 
    left_join(dict_df %>% select(V1 = 1, V2 = 2) %>% setnames("V1", var_name), by = var_name) %>% 
    mutate(!!(var_name) := if_else(is.na(V2), get(var_name), V2), V2 = NULL)
  return(data)
}


test_names_df <- tribble(
  ~code, ~name,
  "golland",        "Тест Голланда",
  "leonhard_poll",  "Опросник Леонгарда-Шмишека",
  "temperament",    "Личностный опросник Айзенка",
  "cattell_poll",   "16-факторный опросник Кеттелла",
  "big_five",       "Пятифакторный опросник личности",
  "schwartz_poll",  "Ценностный опросник Шварца",
  "golland_v2",     "Обновленный тест Голланда"
)

leonhard_rus_factors <- tibble(
  labels = paste0("Г - ", 1:10),
  names = c("Гипертимность", "Дистимность", "Циклотимность", "Неуравновешенность", "Застревание", "Эмотивность", "Экзальтированность", "Тревожность", "Педантичность", "Демонстративность")
)

cattell_rus_factors <- tribble(
  ~labels, ~names,
  "A",  "Открытость - Замкнутость",
  "B",  "Развитое мышление - Ограниченное мышление",
  "C",  "Эмоциональная стабильность - Эмоциональная неустойчивость",
  "E",  "Независимость - Податливость",
  "F",  "Беспечность - Озабоченность",
  "G",  "Сознательность - Беспринципность",
  "H",  "Смелость - Застенчивость",
  "I",  "Чувственность - Твердость",
  "L",  "Подозрительность - Доверчивость",
  "M",  "Мечтательность - Практичность",
  "N",  "Утонченность - Простота",
  "O",  "Склонность к чувству вины - Спокойная самоуверенность",
  "Q1", "Радикализм - Консерватизм",
  "Q2", "Самостоятельность - Зависимость от группы",
  "Q3", "Самоконтроль, сильная воля - Недостаток самоконтроля, индифферентность",
  "Q4", "Внутренняя напряженность - Внутренняя расслабленность"
)
```


```{r message=FALSE, warning=FALSE}
desc_stats <- wide_data %>% 
  psych::describe(skew = FALSE, quant = c(.25, .75)) %>% 
  select(vars, mean, sd, median, Q0.25, Q0.75, min, max) %>% 
  as.data.frame() %>% 
  rownames_to_column("test_feature") %>% 
  filter(!test_feature %in% c("id")) %>% 
  separate_wider_delim(cols = "test_feature", delim = " / ", names = c("test", "feature")) %>% 
  arrange(factor(test, levels = test_names_df[["code"]])) %>% 
  filter(test != "golland_v2") %>% 
  mutate(feature = feature %>% feature_replacement(), vars = row_number()) %>% 
  mutate(feature = if_else(test == "golland", feature %>% golland_enum(), feature)) %>% 
  mutate(across(where(is.numeric), \(x) round(x, digits = 2))) %>% 
  mutate(across(where(is.numeric), \(x) x %>% as.character() %>% str_replace("\\.", ","))) %>% 
  replace_col_using_df("test", test_names_df) %>% 
  replace_col_using_df("feature", leonhard_rus_factors) %>% 
  replace_col_using_df("feature", cattell_rus_factors) %>% 
  transmute(
    `Опросник` = test, 
    `Признак` = feature, 
    `Mean (SD)` = str_glue("{mean} ({sd})"),
    `Median (IQR)` = str_glue("{median} ({Q0.25}-{Q0.75})"),
    `Min` = min,
    `Max` = max
  ) %>% 
  as.data.table() %>% 
  .[, `#` := 1:.N, by = `Опросник`] %>% 
  relocate(`#`, .before = `Признак`)

write.xlsx2(desc_stats, "desc_stats.xlsx", "All", append = TRUE)
```

Отдельно выделим опросник Шварца с его х2 шкалами (нормативный идеал и инд. приоритет)
```{r}
desc_stats %>% 
  .[`Опросник` == "Ценностный опросник Шварца"] %>% 
  separate_wider_delim(cols = "Признак", delim = " - ", names = c("Признак", "norm")) %>% 
  arrange(norm, `Признак`) %>% 
  write.xlsx2("desc_stats.xlsx", "Шварц", append = TRUE)
```


# 5. Графики
```{r}
check_data <- function(wide_data_, test_name) {
  data <- wide_data_ %>% 
    .[, .SD, .SDcols = names(.) %like% paste0("^id$|^", test_name, " ")]
  
  # data %>% show_desc_stats() %>% print()
  # data %>% pairs.panels()
  data %>% outlier()
  # data %>% cor() %>% as.data.frame() %>% print()
  return(NULL)
}


boxplot_data <- function(wide_data_, test_name) {
  data <- wide_data_ %>% 
    .[, .SD, .SDcols = names(.) %like% paste0("^id$|^", test_name, " ")] %>% 
    melt(id.vars = "id") %>% 
    .[, variable := str_replace_all(variable, "\\.|_", " - ")]
  
  plt <- ggplot(data, aes(x = str_wrap(variable, 25), y = value)) + 
    geom_boxplot() +  # box is Q25 and Q75, whiskers are box +- 1.5*IQR
    labs(x = "Фактор", y = "Значение", title = test_name) +
    coord_flip()
    # scale_x_discrete(guide = guide_axis(angle = 15)) # выполнять без coord_flip
  return(plt)
}
```

```{r}
# check_data(wide_data, "cattell_poll")
# boxplot_data(wide_data, "golland")
# 
# lapply(all_tests, boxplot_data, wide_data_ = wide_data)
```

```{r}
library(plotly)

median_levels <- function(df, col_n) {
  median_lvls <- df[, .(m = median(value)), by = c(col_n)][order(m), ..col_n][[1]]
  return(median_lvls)
}


data_transformation <- function(wide_data_, test_name) {
  data <- wide_data_ %>% 
    copy() %>% 
    .[, .SD, .SDcols = names(.) %like% paste0("^id$|^", test_name, " ")] %>% 
    melt(id.vars = "id") %>% 
    .[, variable := str_replace_all(variable, "\\.|_", " - ")] %>% 
    separate_wider_delim(cols = "variable", delim = " / ", names = c("test_name", "feature")) %>%
    mutate(feature = feature %>% feature_replacement(), vars = row_number()) 
  return(data)
}

get_box_plot <- function(data, rus_rest_name, test_name, x_range = c(0, 27), n_str_wrap = 40) {
  data <- data %>% 
    copy() %>% 
    as.data.table() %>% 
    .[, feature := str_wrap(feature, n_str_wrap)] %>%
    .[, feature := factor(feature, levels = median_levels(., "feature"))] 
  
  p <- plot_ly(data = data, x = ~value, y = ~feature, type = "box", 
               colors = "Dark2", color = ~feature) %>% 
    layout(
      title = list(text = paste0("<b>Диаграммы размаха факторов. ", rus_rest_name, "</b>")),
      xaxis = list(title = "<b>Значение фактора</b>"),
      yaxis = list(title = "", standoff = 5), # <b>Фактор</b>
      # margin = list(l = 50),
      showlegend = FALSE,
      font = list(family = "Times New Roman", size = 12)
    ) %>% 
    layout(xaxis = list(range = x_range, zeroline = FALSE)) %>% 
    config(locale = 'ru', displaylogo = FALSE,
           toImageButtonOptions = list(format = 'png', filename = test_name, 
                                       height = 1080/2, width = 1440/2, scale = 2))
  return(p)
}


meta_func <- function(wide_data_, test_name, rus_rest_name, x_range = c(-1, 27), n_str_wrap = 40,
                      custom_func = NULL, ...) {
  data <- data_transformation(wide_data_, test_name)
  
  if (!is.null(custom_func)) {{
    data <- data %>% custom_func(...)
  }}
  
  return(get_box_plot(data, rus_rest_name, test_name, x_range, n_str_wrap))
}
```

```{r message=FALSE, warning=FALSE}
p1 <- meta_func(wide_data, "golland", "Тест Голланда (RIASEC)", 
          custom_func = \(dt) mutate(dt, feature = if_else(test_name == "golland", feature %>% golland_enum(), feature)), 
          x_range = c(-1, 16))

p2 <- meta_func(wide_data, "big_five", "Пятифакторный опросник личности (5PFQ)", x_range = c(-1, 81), n_str_wrap = 30)

p3 <- meta_func(wide_data, "temperament", "Личностный опросник Айзенка (EPQ-R)", x_range = c(-1, 26), n_str_wrap = 30)

p4 <- meta_func(wide_data, "leonhard_poll", "Опросник Леонгарда-Шмишека", 
          custom_func = \(dt) replace_col_using_df(dt, var_name = "feature", dict_df = leonhard_rus_factors), 
          x_range = c(-1, 26))

p7 <- meta_func(wide_data, "cattell_poll", "16-факторный Опросник Кеттелла (16PF)", custom_func = replace_col_using_df, 
          x_range = c(-1, 27), var_name = "feature", dict_df = cattell_rus_factors)

# meta_func(wide_data, "schwartz_poll", "Ценностный опросник Шварца", x_range = c(-1, 100), n_str_wrap = 30)
```

```{r message=FALSE, warning=FALSE}
schwartz_tranformed <- wide_data %>% 
  copy() %>% 
  .[, .SD, .SDcols = names(.) %like% paste0("^id$|^", "schwartz_poll", " ")] %>% 
  melt(id.vars = "id") %>% 
  .[, variable := feature_replacement(variable)] %>% 
  separate_wider_delim(cols = "variable", delim = " / ", names = c("test_name", "feature")) %>% 
  separate_wider_delim(cols = "feature", delim = " - ", names = c("feature", "attr")) %>% 
  arrange(attr, feature) %>% 
  as.data.table()

p5 <- schwartz_tranformed[attr == "нормативный идеал"] %>% 
  get_box_plot(rus_rest_name = "Ценностный опросник Шварца (нормативный идеал)", 
               test_name = "schwartz_poll", x_range = c(-11, 61), n_str_wrap = 30) 
  
p6 <- schwartz_tranformed[attr == "индивидуальный приоритет"] %>% 
  get_box_plot(rus_rest_name = "Ценностный опросник Шварца (индивидуальный приоритет)", 
               test_name = "schwartz_poll", x_range = c(-6, 26), n_str_wrap = 30)
```

# 7. Слайс данных

```{r}
wide_data %>%
  select(id, matches("golland "), matches("big_five"), lp9 = `leonhard_poll / Г.9`, lp10 = `leonhard_poll / Г.10`) %>%
  slice(1:5) %>% 
  mutate(`dots` = "...", .before = "lp9") %>% 
  write.xlsx2("../../0. Data/Output/slice_data.xlsx")
```



Проверить на выбросы по шкалам
Уменьшение размерности?
Метапеременные?
Создать справочник фич, выделив тесты, закодировав фичи.
