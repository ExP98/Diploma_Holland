---
title: "Чтение данных"
author: "Egor Glushkov"
---

# 1. Библиотеки

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
# library(jsonlite)
library(psych) # desc stats
```

```{r}
extract_psytest_result <- function(res_str) {
  res <- res_str %>%
    str_extract("\\{[^\\}]*\\}") %>%
    str_replace_all("\\{|\\}", "") %>%
    str_split_1(",") %>%
    str_split(":") %>%
    sapply(\(elem) setNames(as.list(elem[[2]]), elem[[1]])) %>%
    as.data.frame()
  return(res)
}
```


# 2. Данные

```{r}
data <- fread("D:/Programs/RProjects/Diploma_Holland/0. Data/AllTestsData_092024.csv")
all_tests <- data[["test_short_name"]] %>% unique()

wide_data <- data %>%
  copy() %>% 
  .[, result := lapply(result, extract_psytest_result)] %>% 
  pivot_wider(names_from = "test_short_name", values_from = result) %>% 
  unnest(cols = -id, names_sep = " / ") %>% 
  as.data.table() %>% 
  .[, names(.) := lapply(.SD, as.integer)] %>% 
  # 2 пропуска в кодах Голланда, которые на самом деле нули
  mutate(across(matches("golland "), \(x) replace(x, is.na(x), 0))) %>% 
  # у первых двух субъектов сумма кодов Голланда не 42. Исправим это:
  mutate(`golland / X1` = if_else(id == "10749", 14, `golland / X1`)) %>% 
  mutate(`golland / X6` = if_else(id == "39803",  1, `golland / X6`))
```

Big Five - 5 факторов
temperament - 4
cattell - 16
golland - 6
leonhard - 10
schwartz - 20
golland_v2 - 6
--
id + 67 факторов


# 3. Проверка данных


## Количество тестов у людей и количество людей по тестам
```{r}
data[, .N, by = c("id")][, .N, by = "N"]
data[, .N, by = c("test_short_name")]
```
У 16 человек пройдено 7 тестов, у 323 -- 6 тестов. Тот доп. тест у 16 человек -- golland_v2

## Данные по тесту Большой пятерки
Какие значения у теста большой пятерки:
```{r}
data %>%
  .[test_short_name == "big_five", result] %>%
  .[1]
```
Значения теста большой пятерки:
    Экстраверсия–интроверсия -- -||-
    Привязанность–обособленность -- согласие (конформность, agreebleness)
    Экспрессивность–практичность --  открытость опыту (openness to experience)
    Самоконтроль–импульсивность -- сознательность (conscientiousness)
    Эмоциональная_устойчивость–эмоциональная_неустойчивость -- нейротизм (neuroticism)


## Различные тесты Голланда у одних людей
```{r}
data %>%
  pivot_wider(names_from = "test_short_name", values_from = result) %>%
  filter(!is.na(golland_v2)) %>%
  select(id, golland, golland_v2) %>%
  view()
```


## Корреляции


```{r}
cor_mat <- wide_data %>% cor() 
cor_mat[upper.tri(cor_mat)] <- NA

cor_df <- cor_mat %>% 
  as.data.frame() %>% 
  rownames_to_column("factor1") %>% 
  pivot_longer(cols = -factor1, names_to = "factor2") %>% 
  filter(factor1 != factor2, factor1 != "id", factor2 != "id", !is.na(value)) %>% 
  as.data.table()

cor_df %>% 
  filter(value > 0.6) %>% 
  view()

ggplot(cor_df[value > 0.5], aes(x = value)) +
  geom_histogram(color = "black", fill = "steelblue", bins = 30) +
  labs(x = "Коэффициент корреляции", y = "Частота") + 
  ggtitle("Гистограмма частот для коэффицента корреляции > 0.5") +
  theme_minimal()
```
Среди скоррелированных признаков нет кодов Голланда -- хорошо.


## Пропуски

```{r}
wide_data %>% 
  select(-matches("golland_v2")) %>%
  is.na() %>%
  sum()
```
2 пропуска

```{r}
wide_data %>% is.na() %>% colSums() %>% .[. != 0]
```
Есть по пропуску в golland X1 и X6 (в разных строках) -- заполнить нулями, ибо в тех строках сумма уже 42, значит, там пусто.


## Сумма признаков кода Голланда

Сумма фичей кодов Голланда const? Да, 42
```{r}
wide_data %>%
  select(id, matches("golland ")) %>%
  mutate(rs = rowSums(across(paste0("golland / X", 1:6)), na.rm = TRUE)) %>% 
  # filter(is.na(`golland / X1`) | is.na(`golland / X6`))
  filter(rs != 42)
```
Почти у всех 42, кроме двоих (первых двух!).
- Пользователь 10749: у него 41 в сумме, но у него есть golland_v2, где все значения идентичны, только X1 на 1 больше (и будет 42). Меняем `golland / X1` на 14 у 10749.
- У 39803 на 13 больше нужного. Притом его результаты почти совпадают с результатами второго, у которого 6ой признак на 13 же больше. Меняем его `golland / X6` с 14 на 1.


Проверить такую же сумму по другим тестам. В итоге лишь в golland_v2 сумма постоянна (и там всё ок):
```{r}
wide_data %>%
  select(matches("golland_v2 ")) %>%
  mutate(rs = rowSums(across(everything()), na.rm = TRUE)) %>% 
  filter(rs != 0)
```


# 4. Описательная статистика
```{r}
show_desc_stats <- function(data) {
  return(psych::describe(data, skew = FALSE, quant = c(.25, .75)) %>% 
           select(vars, n, min, Q0.25, mean, median, Q0.75, max, range, sd, se))
}
```

Для каждого теста привести описательную статистику:
```{r}
wide_data %>% show_desc_stats() %>% view()
```

```{r}
check_data <- function(wide_data_, test_name) {
  data <- wide_data_ %>% 
    .[, .SD, .SDcols = names(.) %like% paste0("^id$|^", test_name, " ")]
  
  data %>% show_desc_stats() %>% print()
  # data %>% pairs.panels()
  data %>% outlier()
  data %>% cor() %>% as.data.frame() %>% print()
  return(NULL)
}


boxplot_data <- function(wide_data_, test_name) {
  data <- wide_data_ %>% 
    .[, .SD, .SDcols = names(.) %like% paste0("^id$|^", test_name, " ")] %>% 
    melt(id.vars = "id") %>% 
    .[, variable := str_replace_all(variable, "\\.|_", " - ")]
  
  plt <- ggplot(data, aes(x = str_wrap(variable, 25), y = value)) + 
    geom_boxplot() +  # box is Q25 and Q75, whiskers are box +- 1.5*IQR
    labs(x = "Фактор", y = "Значение", title = test_name) +
    coord_flip()
    # scale_x_discrete(guide = guide_axis(angle = 15)) # выполнять без coord_flip
  return(plt)
}
```

```{r}
check_data(wide_data, "cattell")
boxplot_data(wide_data, "golland")

lapply(all_tests, boxplot_data, wide_data_ = wide_data)
```


Проверить на выбросы по шкалам
Уменьшение размерности?
Метапеременные?
Создать справочник фич, выделив тесты, закодировав фичи.
